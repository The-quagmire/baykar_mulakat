{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="container">
    <h2 class="mb-4">Uçak Montajı</h2>

    <form method="post" id="assemblyForm">
        {% csrf_token %}

        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Uçak Bilgileri</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">Uçak Adı:</label>
                            {{ form.name|add_class:"form-control" }}
                            <div class="text-danger">{{ form.name.errors }}</div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.aircraft_type.id_for_label }}" class="form-label">Uçak Tipi:</label>
                            {{ form.aircraft_type|add_class:"form-control" }}
                            <div class="text-danger">{{ form.aircraft_type.errors }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-warning" id="missingPartsAlert" style="display: none;">
            <strong>Uyarı!</strong> Seçilen uçak tipi için eksik parçalar bulunmaktadır:
            <ul id="missingPartsList"></ul>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Parça Seçimi</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="wing" class="form-label">Kanat:</label>
                            <select name="wing" id="wing" class="form-control" required disabled>
                                <option value="">Önce uçak tipini seçin</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="body" class="form-label">Gövde:</label>
                            <select name="body" id="body" class="form-control" required disabled>
                                <option value="">Önce uçak tipini seçin</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="tail" class="form-label">Kuyruk:</label>
                            <select name="tail" id="tail" class="form-control" required disabled>
                                <option value="">Önce uçak tipini seçin</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="avionics" class="form-label">Aviyonik:</label>
                            <select name="avionics" id="avionics" class="form-control" required disabled>
                                <option value="">Önce uçak tipini seçin</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Uçak Montajı Yap</button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">İptal</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateAvailableParts() {
    const aircraftType = document.getElementById('id_aircraft_type').value;
    if (!aircraftType) return;

    // Parça seçicilerini sıfırla
    document.getElementById('wing').innerHTML = '<option value="">Yükleniyor...</option>';
    document.getElementById('body').innerHTML = '<option value="">Yükleniyor...</option>';
    document.getElementById('tail').innerHTML = '<option value="">Yükleniyor...</option>';
    document.getElementById('avionics').innerHTML = '<option value="">Yükleniyor...</option>';

    // Form gönderme düğmesini devre dışı bırak
    document.getElementById('submitBtn').disabled = true;

    // AJAX ile uyumlu parçaları getir
    fetch(`/api/get-compatible-parts/?aircraft_type=${aircraftType}`)
        .then(response => response.json())
        .then(data => {
            // Envanter durumunu kontrol et
            if (data.inventory_status.missing_parts.length > 0) {
                // Eksik parçaları listele
                const missingPartsList = document.getElementById('missingPartsList');
                missingPartsList.innerHTML = '';
                data.inventory_status.missing_parts.forEach(part => {
                    const li = document.createElement('li');
                    li.textContent = part;
                    missingPartsList.appendChild(li);
                });
                document.getElementById('missingPartsAlert').style.display = 'block';
            } else {
                document.getElementById('missingPartsAlert').style.display = 'none';
            }

            // Wing parçalarını doldur
            const wingSelect = document.getElementById('wing');
            wingSelect.innerHTML = '<option value="">Kanat Seçin</option>';
            data.parts.wings.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = part.name;
                wingSelect.appendChild(option);
            });
            wingSelect.disabled = data.parts.wings.length === 0;

            // Body parçalarını doldur
            const bodySelect = document.getElementById('body');
            bodySelect.innerHTML = '<option value="">Gövde Seçin</option>';
            data.parts.bodies.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = part.name;
                bodySelect.appendChild(option);
            });
            bodySelect.disabled = data.parts.bodies.length === 0;

            // Tail parçalarını doldur
            const tailSelect = document.getElementById('tail');
            tailSelect.innerHTML = '<option value="">Kuyruk Seçin</option>';
            data.parts.tails.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = part.name;
                tailSelect.appendChild(option);
            });
            tailSelect.disabled = data.parts.tails.length === 0;

            // Avionics parçalarını doldur
            const avionicsSelect = document.getElementById('avionics');
            avionicsSelect.innerHTML = '<option value="">Aviyonik Seçin</option>';
            data.parts.avionics.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = part.name;
                avionicsSelect.appendChild(option);
            });
            avionicsSelect.disabled = data.parts.avionics.length === 0;

            // Eğer eksik parça yoksa submit butonunu aktifleştir
            document.getElementById('submitBtn').disabled = data.inventory_status.missing_parts.length > 0;
        })
        .catch(error => {
            console.error('Parça bilgileri alınırken hata oluştu:', error);
        });
}

// Sayfa yüklendiğinde uçak tipi değiştikçe parçaları güncelle
document.addEventListener('DOMContentLoaded', function() {
    const aircraftTypeSelect = document.getElementById('id_aircraft_type');
    aircraftTypeSelect.addEventListener('change', updateAvailableParts);
});
</script>
{% endblock %}